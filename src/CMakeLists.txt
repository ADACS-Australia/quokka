#find_package(PythonLibs)
if(PythonLibs_FOUND)
    add_compile_definitions(HAVE_PYTHON)
    include_directories(${PYTHON_INCLUDE_DIRS})
    link_libraries(${PYTHON_LIBRARY})
endif()

if (CMAKE_BUILD_TYPE STREQUAL "Debug")
    include(CodeCoverage) # only works with gcc!
    setup_target_for_coverage_lcov(
          NAME coverage
          EXECUTABLE ${CMAKE_CTEST_COMMAND} -j2
          EXCLUDE "${PROJECT_SOURCE_DIR}/extern/*")
    append_coverage_compiler_flags()
endif()

include_directories(${amrex_INCLUDE_DIRS_RET})
include_directories(${fmt_INCLUDE_DIRS_RET})

link_libraries(AMReX::amrex)
link_libraries(fmt::fmt)

add_executable(test_advection main.cpp test_advection.cpp fextract.cpp)
add_executable(test_advection_se main.cpp test_advection_semiellipse.cpp fextract.cpp)
add_executable(test_radiation_matter_coupling main.cpp test_radiation_matter_coupling.cpp fextract.cpp interpolate.c)
add_executable(test_radiation_matter_coupling_rsla main.cpp test_radiation_matter_coupling_rsla.cpp fextract.cpp interpolate.c)
add_executable(test_radiation_SuOlson main.cpp test_radiation_SuOlson.cpp fextract.cpp interpolate.c)
add_executable(test_radiation_marshak main.cpp test_radiation_marshak.cpp fextract.cpp interpolate.c)
add_executable(test_radiation_marshak_cgs main.cpp test_radiation_marshak_cgs.cpp fextract.cpp interpolate.c)
#add_executable(test_radiation_marshak_asymptotic main.cpp test_radiation_marshak_asymptotic.cpp interpolate.c)
#add_executable(test_radiation_pulse main.cpp test_radiation_pulse.cpp)
#add_executable(test_radiation_streaming main.cpp test_radiation_streaming.cpp)
add_executable(test_radhydro_shock main.cpp test_radhydro_shock.cpp fextract.cpp interpolate.c)
add_executable(test_radhydro_shock_cgs main.cpp test_radhydro_shock_cgs.cpp fextract.cpp interpolate.c)
add_executable(test_hydro_shocktube main.cpp test_hydro_shocktube.cpp fextract.cpp interpolate.c)
add_executable(test_hydro_leblanc main.cpp test_hydro_leblanc.cpp fextract.cpp interpolate.c)
add_executable(test_hydro_shuosher main.cpp test_hydro_shuosher.cpp fextract.cpp interpolate.c)
add_executable(test_hydro_sms main.cpp test_hydro_sms.cpp fextract.cpp)
add_executable(test_hydro_contact main.cpp test_hydro_contact.cpp fextract.cpp)
add_executable(test_hydro_vacuum main.cpp test_hydro_vacuum.cpp fextract.cpp interpolate.c)
add_executable(test_hydro_wave main.cpp test_hydro_wave.cpp fextract.cpp)

if(AMReX_GPU_BACKEND MATCHES "CUDA")
    setup_target_for_cuda_compilation(test_radiation_matter_coupling)
    setup_target_for_cuda_compilation(test_radiation_SuOlson)
    setup_target_for_cuda_compilation(test_radiation_marshak_cgs)
    setup_target_for_cuda_compilation(test_radiation_marshak)
    setup_target_for_cuda_compilation(test_radhydro_shock_cgs)
    setup_target_for_cuda_compilation(test_hydro_contact)
    setup_target_for_cuda_compilation(test_advection)
    setup_target_for_cuda_compilation(test_advection_se)
endif(AMReX_GPU_BACKEND MATCHES "CUDA")

if (AMReX_SPACEDIM GREATER_EQUAL 2)
    add_executable(test_advection2d main.cpp test_advection2d.cpp)
    add_executable(test_hydro2d_blast main.cpp test_hydro2d_blast.cpp)
    add_executable(test_hydro2d_kh main.cpp test_hydro2d_kh.cpp)
    add_executable(test_hydro2d_rm main.cpp test_hydro2d_rm.cpp)
    add_executable(test_radiation_shadow main.cpp test_radiation_shadow.cpp)
    add_executable(test_radiation_beam main.cpp test_radiation_beam.cpp)
    #add_executable(test_radiation_tophat main.cpp test_radiation_tophat.cpp)
    if(AMReX_GPU_BACKEND MATCHES "CUDA")
        setup_target_for_cuda_compilation(test_advection2d)
        setup_target_for_cuda_compilation(test_hydro2d_blast)
        setup_target_for_cuda_compilation(test_hydro2d_kh)
        setup_target_for_cuda_compilation(test_hydro2d_rm)
        setup_target_for_cuda_compilation(test_radiation_shadow)
        setup_target_for_cuda_compilation(test_radiation_beam)
    endif()
endif()

if (AMReX_SPACEDIM EQUAL 3)
    add_executable(test_radhydro3d_shell main.cpp test_radhydro_shell.cpp)
    add_executable(test_hydro3d_blast main.cpp test_hydro3d_blast.cpp)
    if(AMReX_GPU_BACKEND MATCHES "CUDA")
        setup_target_for_cuda_compilation(test_radhydro3d_shell)
        setup_target_for_cuda_compilation(test_hydro3d_blast)
    endif()
endif()


include(CTest)
message(DEBUG "CMAKE_SOURCE_DIR: ${CMAKE_SOURCE_DIR}")
add_test(NAME ScalarAdvection COMMAND test_advection advection_sawtooth.in WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}/tests)
add_test(NAME ScalarAdvectionSemiEllipse COMMAND test_advection_se advection_semiellipse.in WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}/tests)
add_test(NAME MatterEnergyExchange COMMAND test_radiation_matter_coupling energyexchange.in WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}/tests)
add_test(NAME MatterEnergyExchangeRSLA COMMAND test_radiation_matter_coupling_rsla MatterEnergyExchangeRSLA.in WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}/tests)
add_test(NAME SuOlsonTest COMMAND test_radiation_SuOlson SuOlson.in WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}/tests)
add_test(NAME MarshakWave COMMAND test_radiation_marshak Marshak.in WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}/tests)
add_test(NAME MarshakWaveCGS COMMAND test_radiation_marshak_cgs MarshakCGS.in WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}/tests)
# add_test(NAME MarshakWaveAsymptoticDiffusion COMMAND test_radiation_marshak_asymptotic WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}/tests)
# add_test(NAME RadiationStreaming COMMAND test_radiation_streaming WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}/tests)
# add_test(NAME RadiationPulse COMMAND test_radiation_pulse WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}/tests)
add_test(NAME RadhydroShock COMMAND test_radhydro_shock radshock_dimensionless.in WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}/tests)
add_test(NAME RadhydroShockCGS COMMAND test_radhydro_shock_cgs radshock.in WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}/tests)
add_test(NAME HydroShocktube COMMAND test_hydro_shocktube shocktube.in WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}/tests)
add_test(NAME HydroLeblanc COMMAND test_hydro_leblanc leblanc.in WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}/tests)
add_test(NAME HydroSlowMovingShock COMMAND test_hydro_sms SlowMovingShock.in WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}/tests)
add_test(NAME HydroContact COMMAND test_hydro_contact contact_wave.in WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}/tests)
add_test(NAME HydroVacuum COMMAND test_hydro_vacuum vacuum.in WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}/tests)
add_test(NAME HydroWave COMMAND test_hydro_wave hydro_wave.in WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}/tests)
add_test(NAME ShuOsher COMMAND test_hydro_shuosher ShuOsher.in WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}/tests)
