\RequirePackage{snapshot}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Basic setup. Most papers should leave these options alone.
\documentclass[fleqn,usenatbib]{mnras}

% MNRAS is set in Times font. If you don't have this installed (most LaTeX
% installations will be fine) or prefer the old Computer Modern fonts, comment
% out the following line
\usepackage{newtxtext,newtxmath}
% Depending on your LaTeX fonts installation, you might get better results with one of these:
%\usepackage{mathptmx}
%\usepackage{txfonts}

% Use vector fonts, so it zooms properly in on-screen viewing software
% Don't change these lines unless you know what you are doing
\usepackage[T1]{fontenc}

% Allow "Thomas van Noord" and "Simon de Laguarde" and alike to be sorted by "N" and "L" etc. in the bibliography.
% Write the name in the bibliography as "\VAN{Noord}{Van}{van} Noord, Thomas"
\DeclareRobustCommand{\VAN}[3]{#2}
\let\VANthebibliography\thebibliography
\def\thebibliography{\DeclareRobustCommand{\VAN}[3]{##3}\VANthebibliography}


%%%%% AUTHORS - PLACE YOUR OWN PACKAGES HERE %%%%%

% Only include extra packages if you really need them. Common packages are:
\usepackage{graphicx}	% Including figure files
\usepackage{amsmath}	% Advanced maths commands
\usepackage{fontawesome}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%% AUTHORS - PLACE YOUR OWN COMMANDS HERE %%%%%

\newcommand{\Msun}{M$_{\odot}$} % Msun (solar mass)
\newcommand{\microgauss}{$\mu$G} % microgauss
\newcommand{\vc}[1]{{\mathbf{#1}}}

% Workaround to fix the bug that prevents autoref from handling appendices properly
\newcommand{\aref}[1]{\hyperref[#1]{Appendix~\ref{#1}}}

% Autoref section names
\def\sectionautorefname{Section}
\def\subsectionautorefname{Section}
\def\subsubsectionautorefname{Section}
\def\paragraphautorefname{Section}
\def\figureautorefname{Figure}
\def\tableautorefname{Table}
\def\equationautorefname{equation}
\def\appendixautorefname{Appendix}


% MRK's editing macros
\usepackage{color}
\usepackage[normalem]{ulem}
\definecolor{darkgreen}{rgb}{0.13, 0.55, 0.13}
\newcommand{\red}[1]{{\textcolor{red}{#1}}}
\newcommand{\cyan}[1]{{\textcolor{cyan}{#1}}}
\newcommand{\mrkcut}[1]{{\red{\sout{#1}}}}
\newcommand{\mrkadd}[1]{{\cyan{#1}}}
\newcommand{\mrknote}[1]{{\textcolor{darkgreen}{[MRK: #1]}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%% TITLE PAGE %%%%%%%%%%%%%%%%%%%

% Title of the paper, and the short title which is used in the headers.
% Keep the title short and informative.
\title[Two-moment radiation hydrodynamics on GPUs]{\textsc{Quokka}: A new code for two-moment radiation hydrodynamics on GPUs}

% The list of authors, and the short list which is used in the headers.
% If you need two or more lines of authors, add an extra line using \newauthor
\author[B. D. Wibking et al.]{
    Benjamin D. Wibking$^{1}$\thanks{E-mail: ben.wibking@anu.edu.au (BDW)}
    and Mark R. Krumholz$^{1}$
\\
% List of institutions
$^{1}$Research School of Astronomy \& Astrophysics, Mount Stromlo Observatory, Cotter Road, Weston Creek, ACT 2611 Australia\\
}

% These dates will be filled out by the publisher
\date{Accepted XXX. Received YYY; in original form ZZZ}

% Enter the current year, for the copyright statements etc.
\pubyear{2021}

% Don't change these lines
\begin{document}
\label{firstpage}
\pagerange{\pageref{firstpage}--\pageref{lastpage}}
\maketitle

% Abstract of the paper
\begin{abstract}
    We present a new subcycling-in-time, block-structured adaptive mesh refinement (AMR) radiation hydrodynamics code for graphics processing units (GPUs). The equations of hydrodynamics are solved with the piecewise parabolic method (PPM) in a method-of-lines formulation and the radiative transfer is solved via the variable Eddington tensor (VET) radiation moment equations with a local closure. We combine explicit-in-time evolution of the radiation moment equations with the reduced speed-of-light approximation. We show results for a range of test problems, including radiative shocks, blast waves, and turbulent radiation-gas interactions. On uniform grids in 3D, we achieve a peak of $69$ million hydrodynamic updates per second per GPU. For radiation hydrodynamics problems on uniform grids in 3D, our code scales from 4 GPUs to 256 GPUs with an efficiency of $>93$ per cent. The code is publicly released under an open-source license on \faGithub\href{https://github.com/BenWibking/quokka-code}{GitHub}.
\end{abstract}

% Select between one and six entries from the list of approved keywords.
% Don't make up new ones.
\begin{keywords}
radiation hydrodynamics -- numerical methods
\end{keywords}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%% BODY OF PAPER %%%%%%%%%%%%%%%%%%

\section{Introduction}
Detailed simulations of star formation require treating the dynamical effects of radiation produced by protostars and re-radiated by dust grains in the interstellar medium. A long-standing method to compute the radiation transport in hydrodynamic simulations is the approximation of flux-limited diffusion (FLD) \citep{Alme_1973}. This method evolves the radiation energy density under the assumption of a given closure for the radiation pressure tensor and the assumption that the time derivative of the radiation flux is zero.

A more accurate approximation is to evolve both the radiation energy density and the radiation flux, while still invoking a closure relation for the radiation pressure tensor. When the radiation pressure tensor (or rather, the ratio of the radiation pressure tensor to the radiatio energy density, known as the Eddington tensor) is computed via a formal solution of the angle-dependent radiative transfer equation, we obtain the quasidiffusion or variable Eddington tensor (VET) method \citep{Goldin_1964}. When retaining a local closure for the radiation pressure tensor in terms of the radiation energy density $E$ and the flux $F$, we obtain a local VET method, commonly referred to as the M1 (`moment-one`) method \citep{Minerbo_1978,Levermore_1984,Dubroca_1999,Gonzalez_2007}.

Something about the reduced speed of light method, citing \cite{Gnedin_2001} and \cite{Skinner_2013}\dots

% MRK I have changed your \vec's to \mathbf's, because that's MNRAS house style. However, if you feel strongly, you can easily change them back, because I did it all through a new macro, \vc, which maps to \mathbf

% MRK I replaced all your reduced-speed-of-light's with RSLA, on the assumption that you will introduce this acronym at some point in the intro

\section{Methods}
\label{section:methods}
\subsection{Equations}
We solve the equations of radiation hydrodynamics \citep{Pomraning_1973,Mihalas_1984,Castor_2004} for an inviscid, nonrelativistic fluid
% MRK added note about LTE, since you're going to use the Planck function below
in local thermodynamic equilibrium
% MRK original text resumes
in the so-called ``mixed frame,'' where the radiation variables are defined in an inertial frame (i.e., Eulerian simulation coordinates) and the radiation-matter interaction terms are written 
%MRK rephrased, because it is in fact possible to write the mixed-frame equations in a way that is exact, without series expanding in v/c -- there's a paper by Mihalas & Auer that does this. Of course the resulting expressions are terrifying, so no one uses them...
%as an expansion in the ratio of the fluid velocity to the speed of light $\beta = v/c$. 
in the frame comoving with the fluid, with the transformations between the frames accounted for via the addition of radiation-matter exchange terms that depend explicitly on the ratio of fluid velocity to the speed of light, $\beta=v/c$.
% MRK original text resumes
We write the equations as follows:
\begin{align}
    \frac{\partial \rho}{\partial t} + \nabla \cdot (\rho \vc{v}) = 0 \, , \\
    \frac{\partial (\rho \vc{v})}{\partial t} + \nabla \cdot (\rho \vc{v} \vc{v} + \mathsf{P}) = \vc{G} \, , \\
    \frac{\partial E}{\partial t} + \nabla \cdot \left[(E + \mathsf{P})\vc{v}\right] = c G^0 \, , \\
    \frac{\partial E_r}{\partial t} + \nabla \cdot {\vc{F}_r} = -c G^0 \, , \\\
    \frac{1}{c^2}\frac{\partial \vc{F}_r}{\partial t} + \nabla \cdot \mathsf{P}_r = -\vc{G} \, ,
\end{align}
where $\rho$ is the gas density, $\vc{v}$ is the gas velocity, $E$ is the total energy density of the gas, $\mathsf{P} = \delta_{ij} P$ is the gas pressure tensor, $E_r$ is the radiation energy density, $F_r$ is the radiation flux, $\mathsf{P_r}$ is the radiation pressure tensor, $\nabla \cdot \rho \vc{v} \vc{v}$ denotes the sum $(\rho v_i v^j)_{,j}\,$, and $G^i$ is the radiation four-force, with $G_0$ the time-like component and $\vc{G}$ consisting of the space-like components. 
% MRK I expanded this to properly distinguish between flux mean and Planck mean, since your code does; also, rephrased to make the mixed versus comoving frame issue clear
%Expanding the right-hand side of the comoving-frame radiative transfer equation to linear order in $\beta$ and taking angular moments, we obtain the radiation four-force in terms of the laboratory-frame radiation quantities with a grey (i.e., frequency averaged) comoving-frame opacity $\rho \kappa$:
In the mixed-frame formulation, the radiation four-force to order $\beta$ is
\begin{align}
-c G^0 = \rho \kappa_P(4 \pi B - c E_r) + \rho \kappa_F \left( \frac{\vc{v}}{c} \cdot \vc{F}_r \right) \, , \\
-\vc{G} = -\rho \kappa_F \frac{\vc{F}_r}{c} + \rho \kappa_P \left(\frac{4 \pi B}{c}\right) \frac{\vc{v}}{c} + \rho \kappa_F \frac{\vc{v}\mathsf{P}_r}{c} \, ,
\end{align}
where
% MRK
$\kappa_F$ and $\kappa_P$ are the flux-mean and Planck-mean specific opacity evaluated in the comoving frame,
% MRK original text resumes
% MRK rephrased
%$4\pi B$ is the emissivity of the gas,
$B$ is the Planck function evaluated at the gas temperature,
% MRK original text resumes
and $\vc{v} \mathsf{P}_r$ is the tensor contraction $v_j \mathsf{P}^{ij}$ \citep{Mihalas_1984}. The latter two terms in the expression for $\vc{G}$ correspond to the relativistic work term of \cite{Krumholz_2007} and are only important in the regime $\beta \tau \gtrsim 1$ (where $\tau$ is a characteristic optical depth), 
% MRK rephrased
%and the reduced-speed-of-light approximation cannot treat this regime (as discussed in the following section) 
to which we cannot apply the RSLA (as discussed below),
% MRK original text resumes
so we neglect them. However, the term of order $\beta$ in the expression for $cG^0$ corresponds to the work done by the radiation force on the gas and can be the dominant term for problems of interest. 
% MRK I commented out the statement below because it is not correct. The whole point of the mixed-frame formulation is that kappa is the opacity evaluated in the comoving frame. We're not neglecting the difference between the comoving and lab-frame opacities; that difference is the reason that the various velocity-dependent terms in G appeared. 
%In the nonrelativistic regime, we can neglect the difference between the comoving-frame opacity and the laboratory frame opacity, which we do for the remainder of this work, separately considering $\rho$ as the (nonrelativistic) gas mass density and $\kappa$ as the specific opacity.

To apply the RSLA to these equations, we first rewrite the radiation moment equations so that they have a factor of exactly $1/c$ next to each of the time derivatives:
\begin{align}
    \frac{1}{c} \frac{\partial E_r}{\partial t} + \nabla \cdot \left( \frac{\vc{F}_r}{c} \right) = -G^0 \, , \\\
    \frac{1}{c} \frac{\partial}{\partial t} \left( \frac{\vc{F_r}}{c} \right) + \nabla \cdot \mathsf{P_r} = -\vc{G} \, ,
\end{align}
then we replace this $1/c$ factor with a factor of $1/\hat c$, where $\hat c$ is the reduced speed of light, and multiply through by factors of $\hat c$ to obtain the conservation law form of the reduced speed of light radiation moment equations:
\begin{align}
    \frac{\partial E_r}{\partial t} + \nabla \cdot \left( \frac{\hat c}{c} \vc{F}_r \right) = -\hat c G^0 \, , \\\
    \frac{\partial \vc{F_r}}{\partial t} + \nabla \cdot (c \hat c \, \mathsf{P_r}) = -c \hat c \, \vc{G} \, .
\end{align}
As emphasised by \cite{Skinner_2013}, all other factors of $c$ remain unchanged. In particular, since the factors of $c$ are unchanged on the right-hand side of the hydrodynamic equations, the reduced speed of light radiation hydrodynamic system does not conserve total energy or momentum
% MRK added
for $\hat{c} \neq c$. 
In steady state, this implies that the equilibrium temperature of the reduced speed of light system is modified with respect to the correct equilibrium temperature (see section \ref{test:exchange}). Writing out the right-hand side terms explicitly, we obtain
% Changed your kappa_R's to kappa_F's here, since in fact what appears is the flux-mean opacity. We can later on assume that flux-mean = Rosseland mean, but that is a separate approximation that we are not required to make
\begin{align}
    \frac{\partial \rho}{\partial t} + \nabla \cdot (\rho \vc{v}) = 0 \, , \\
    \frac{\partial (\rho \vc{v})}{\partial t} + \nabla \cdot (\rho \vc{v} \vc{v} + \mathsf{P}) = \rho \kappa_F {\vc{F}_r / c} \, , \\
    \frac{\partial E}{\partial t} + \nabla \cdot \left[(E + \mathsf{P})\vc{v}\right] = -c \rho \kappa_P (a_r T^4 - E_r) - \rho \kappa_F \left( \frac{\vc{v}}{c} \cdot \vc{F}_r \right) \, , \\
    \frac{\partial E_r}{\partial t} + \nabla \cdot \left( \frac{\hat c}{c} \vc{F}_r \right) = \hat c \rho \kappa_P  \left( a_r T^4 - E_r \right) + \rho \kappa_F \left( \frac{\hat c}{c} \frac{\vc{v}}{c} \cdot \vc{F}_r \right) \, , \\\
    \frac{\partial \vc{F}_r}{\partial t} + \nabla \cdot (c \hat c \, \mathsf{P}_r) = -\hat c \rho \kappa_F \vc{F}_r \, .
\end{align}
% MRK commented this out because I introduced it above
%where we have additionally make the conventional association in grey radiation hydrodynamics of the opacities in the momentum equation with the Rosseland mean opacity $\kappa_R$ and the opacities in the energy equation with the Planck mean opacity $\kappa_P$. Since the work done by radiation is an integral of the momentum source term, the work term also uses the Rosseland mean opacity.
% MRK added
In what follows we will approximate $\kappa_F$ with the Rosseland mean opacity $\kappa_R$, which
%This choice of opacities 
yields the correct radiation force in the diffusion limit, and yields the correct energy absorption and emission in the optically-thin limit for fluids at rest \citep{Mihalas_1984}.
% MRK added
However, we emphasise that the choice to set $\kappa_F \approx \kappa_R$ is an additional approximation, and that others might be preferable depending on the physical system being simulated.
% MRK original text resumes
This set of equations is sufficient for nonrelativistic radiation hydrodynamics in the semi-transparent regime, where we can neglect the `relativistic work term' that is important only in the dynamic diffusion ($\beta \tau \gtrsim 1$) regime, as described earlier.

\subsection{Hydrodynamics}

\subsection{Radiation}
Why did we chose the methods we did. Efficiency, GPU, etc.
\subsubsection{Closure relations}

\section{Test problems}
\label{section:tests}

\subsection{Hydrodynamics}
\subsubsection{Sound wave}
\subsubsection{Contact wave}
\subsubsection{Stationary shock tube}
\subsubsection{`Leblanc' test}
\subsubsection{Wave-shock interaction (Shu-Osher test)}
\subsubsection{Slow-moving shock}
\subsubsection{Strong rarefaction}
\subsubsection{Kelvin-Helmholtz problem}
\subsubsection{2D Implosion problem}

\subsection{Radiation}
\subsubsection{Marshak wave}
\subsubsection{Su-Olson problem}
\subsubsection{Radiation pressure tube}
\subsubsection{Radiation-matter energy exchange}
\subsubsection{Shadow test}
\subsubsection{Beam test}
\subsubsection{Optically-thin wind}
\subsubsection{Crooked-pipe problem}

\subsection{Radiation hydrodynamics}
\subsubsection{Subcritical radiative shock}
\subsubsection{Radiation-driven dust shell}

\section{Performance and scaling}
\label{section:performance}

\section{Discussion and Conclusions}
\label{section:discussion}
\subsection{Range of applicability}
\subsection{Planned applications}

The future is bright for radiation hydrodynamics on GPUs\dots

\section*{Acknowledgements}

This research was supported by the Australian Research Council through its Discovery Projects and Future Fellowship Funding Schemes, awards DP190101258 and FT180100375. This research was undertaken with the assistance of resources and services from the National Computational Infrastructure (NCI), which is supported by the Australian Government.

\emph{Software:} AMReX \citep{the_amrex_development_team_2021_5363443},
matplotlib \citep{Hunter:2007},
numpy \citep{harris2020array}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section*{Data Availability}
The source code and entire commit history for \textsc{Quokka} is hosted in this public \faGithub\href{https://github.com/BenWibking/quokka-code}{GitHub repository}. The version of the source code used to produce the results in this paper as well as the output files at the final timestep for the simulations shown in the Figures are permanently archived at Zenodo DOI:XXX.

%%%%%%%%%%%%%%%%%%%% REFERENCES %%%%%%%%%%%%%%%%%%

% The best way to enter references is to use BibTeX:

\bibliographystyle{mnras}
\bibliography{quokka} % if your bibtex file is called example.bib

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%% APPENDICES %%%%%%%%%%%%%%%%%%%%%

\appendix

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


% Don't change these lines
\bsp	% typesetting comment
\label{lastpage}
\end{document}

% End of mnras_template.tex
