\RequirePackage{snapshot}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Basic setup. Most papers should leave these options alone.
\documentclass[fleqn,usenatbib]{mnras}

% MNRAS is set in Times font. If you don't have this installed (most LaTeX
% installations will be fine) or prefer the old Computer Modern fonts, comment
% out the following line
\usepackage{newtxtext,newtxmath}
% Depending on your LaTeX fonts installation, you might get better results with one of these:
%\usepackage{mathptmx}
%\usepackage{txfonts}

% Use vector fonts, so it zooms properly in on-screen viewing software
% Don't change these lines unless you know what you are doing
\usepackage[T1]{fontenc}

% Allow "Thomas van Noord" and "Simon de Laguarde" and alike to be sorted by "N" and "L" etc. in the bibliography.
% Write the name in the bibliography as "\VAN{Noord}{Van}{van} Noord, Thomas"
\DeclareRobustCommand{\VAN}[3]{#2}
\let\VANthebibliography\thebibliography
\def\thebibliography{\DeclareRobustCommand{\VAN}[3]{##3}\VANthebibliography}


%%%%% AUTHORS - PLACE YOUR OWN PACKAGES HERE %%%%%

% Only include extra packages if you really need them. Common packages are:
\usepackage{graphicx}	% Including figure files
\usepackage{amsmath}	% Advanced maths commands
\usepackage{fontawesome}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%% AUTHORS - PLACE YOUR OWN COMMANDS HERE %%%%%

\newcommand{\Msun}{M$_{\odot}$} % Msun (solar mass)
\newcommand{\microgauss}{$\mu$G} % microgauss

% Workaround to fix the bug that prevents autoref from handling appendices properly
\newcommand{\aref}[1]{\hyperref[#1]{Appendix~\ref{#1}}}

% Autoref section names
\def\sectionautorefname{Section}
\def\subsectionautorefname{Section}
\def\subsubsectionautorefname{Section}
\def\paragraphautorefname{Section}
\def\figureautorefname{Figure}
\def\tableautorefname{Table}
\def\equationautorefname{equation}
\def\appendixautorefname{Appendix}


% MRK's editing macros
\usepackage{color}
\usepackage[normalem]{ulem}
\definecolor{darkgreen}{rgb}{0.13, 0.55, 0.13}
\newcommand{\red}[1]{{\textcolor{red}{#1}}}
\newcommand{\cyan}[1]{{\textcolor{cyan}{#1}}}
\newcommand{\mrkcut}[1]{{\red{\sout{#1}}}}
\newcommand{\mrkadd}[1]{{\cyan{#1}}}
\newcommand{\mrknote}[1]{{\textcolor{darkgreen}{[MRK: #1]}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%% TITLE PAGE %%%%%%%%%%%%%%%%%%%

% Title of the paper, and the short title which is used in the headers.
% Keep the title short and informative.
\title[Two-moment radiation hydrodynamics on GPUs]{\textsc{Quokka}: A new code for two-moment radiation hydrodynamics on GPUs}

% The list of authors, and the short list which is used in the headers.
% If you need two or more lines of authors, add an extra line using \newauthor
\author[B. D. Wibking et al.]{
    Benjamin D. Wibking$^{1}$\thanks{E-mail: ben.wibking@anu.edu.au (BDW)}
    and Mark R. Krumholz$^{1}$
\\
% List of institutions
$^{1}$Research School of Astronomy \& Astrophysics, Mount Stromlo Observatory, Cotter Road, Weston Creek, ACT 2611 Australia\\
}

% These dates will be filled out by the publisher
\date{Accepted XXX. Received YYY; in original form ZZZ}

% Enter the current year, for the copyright statements etc.
\pubyear{2021}

% Don't change these lines
\begin{document}
\label{firstpage}
\pagerange{\pageref{firstpage}--\pageref{lastpage}}
\maketitle

% Abstract of the paper
\begin{abstract}
    We present a new subcycling-in-time, block-structured adaptive mesh refinement (AMR) radiation hydrodynamics code for graphics processing units (GPUs). The equations of hydrodynamics are solved with the piecewise parabolic method (PPM) in a method-of-lines formulation and the radiative transfer is solved via the variable Eddington tensor (VET) radiation moment equations with a local closure. We combine explicit-in-time evolution of the radiation moment equations with the reduced speed-of-light approximation. We show results for a range of test problems, including radiative shocks, blast waves, and turbulent radiation-gas interactions. On uniform grids in 3D, we achieve a peak of $69$ million hydrodynamic updates per second per GPU. For radiation hydrodynamics problems on uniform grids in 3D, our code scales from 4 GPUs to 256 GPUs with an efficiency of $>93$ per cent. The code is publicly released under an open-source license on \faGithub\href{https://github.com/BenWibking/quokka-code}{GitHub}.
\end{abstract}

% Select between one and six entries from the list of approved keywords.
% Don't make up new ones.
\begin{keywords}
radiation hydrodynamics -- numerical methods
\end{keywords}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%% BODY OF PAPER %%%%%%%%%%%%%%%%%%

\section{Introduction}
Detailed simulations of star formation require treating the dynamical effects of radiation produced by protostars and re-radiated by dust grains in the interstellar medium. A long-standing method to compute the radiation transport in hydrodynamic simulations is the approximation of flux-limited diffusion (FLD) \citep{Alme_1973}. This method evolves the radiation energy density under the assumption of a given closure for the radiation pressure tensor and the assumption that the time derivative of the radiation flux is zero.

A more accurate approximation is to evolve both the radiation energy density and the radiation flux, while still invoking a closure relation for the radiation pressure tensor. When the radiation pressure tensor (or rather, the ratio of the radiation pressure tensor to the radiatio energy density, known as the Eddington tensor) is computed via a formal solution of the angle-dependent radiative transfer equation, we obtain the quasidiffusion or variable Eddington tensor (VET) method \citep{Goldin_1964}. When retaining a local closure for the radiation pressure tensor in terms of the radiation energy density $E$ and the flux $F$, we obtain a local VET method, commonly referred to as the M1 (`moment-one`) method \citep{Minerbo_1978,Levermore_1984,Dubroca_1999,Gonzalez_2007}.

Something about the reduced speed of light method, citing \cite{Gnedin_2001} and \cite{Skinner_2013}\dots

\section{Methods}
\label{section:methods}
\subsection{Equations}
We solve the equations of radiation hydrodynamics \citep{Pomraning_1973,Mihalas_1984,Castor_2004} for an inviscid, nonrelativistic fluid in the so-called `mixed frame,' where the radiation variables are defined in an inertial frame (i.e., Eulerian simulation coordinates) and the radiation-matter interaction terms are written as an expansion in the ratio of the fluid velocity to the speed of light $\beta = v/c$. We write the equations as follows:
\begin{align}
    \frac{\partial \rho}{\partial t} + \nabla \cdot (\rho \vec{v}) = 0 \, , \\
    \frac{\partial (\rho \vec{v})}{\partial t} + \nabla \cdot (\rho \vec{v} \vec{v} + \mathsf{P}) = \vec{G} \, , \\
    \frac{\partial E}{\partial t} + \nabla \cdot \left[(E + \mathsf{P})\vec{v}\right] = c G^0 \, , \\
    \frac{\partial E_r}{\partial t} + \nabla \cdot {\vec{F}_r} = -c G^0 \, , \\\
    \frac{1}{c^2}\frac{\partial \vec{F}_r}{\partial t} + \nabla \cdot \mathsf{P_r} = -\vec{G} \, ,
\end{align}
where $\rho$ is the gas density, $\vec{v}$ is the gas velocity, $E$ is the total energy density of the gas, $\mathsf{P} = \delta_{ij} P$ is the gas pressure tensor, $E_r$ is the radiation energy density, $F_r$ is the radiation flux, $\mathsf{P_r}$ is the radiation pressure tensor, $\nabla \cdot \rho \vec{v} \vec{v}$ denotes the sum $(\rho v_i v^j)_{,j}\,$, and $G^i$ is the radiation four-force, with $G_0$ the time-like component and $\vec{G}$ consisting of the space-like components. Expanding to linear order in $\beta$, we obtain the radiation four-force in terms of the laboratory-frame radiation quantities with a gray specific opacity $\kappa$:
\begin{align}
-c G^0 = \rho \kappa(4 \pi B - c E_r) + \rho \kappa \left( \frac{\vec{v}}{c} \cdot \vec{F_r} \right) \, , \\
-\vec{G} = -\rho \kappa \frac{\vec{F_r}}{c} + \rho \kappa \left(\frac{4 \pi B}{c}\right) \frac{\vec{v}}{c} + \rho \kappa \frac{\vec{v}\mathsf{P_r}}{c} \, ,
\end{align}
where $4\pi B$ is the emissivity of the gas and $\vec{v} \mathsf{P_r}$ is the tensor contraction $v_j \mathsf{P}^{ij}$ \citep{Mihalas_1984}. The latter two terms in the expression for $\vec{G}$ correspond to the relativistic work term of \cite{Krumholz_2007} and are only important in the regime $\beta \tau \gtrsim 1$ (where $\tau$ is a characteristic optical depth), so we neglect them hereafter. However, the term of order $\beta$ in the expression for $cG^0$ corresponds to the work done by the radiation force on the gas and can be the dominant term for problems of interest.

Reduced-speed-of-light equations here\dots

\subsection{Hydrodynamics}

\subsection{Radiation}

\section{Test problems}
\label{section:tests}

\subsection{Hydrodynamics}
\subsubsection{Sound wave}
\subsubsection{Contact wave}
\subsubsection{Stationary shock tube}
\subsubsection{`Leblanc' test}
\subsubsection{Wave-shock interaction (Shu-Osher test)}
\subsubsection{Slow-moving shock}
\subsubsection{Strong rarefaction}
\subsubsection{Kelvin-Helmholtz problem}
\subsubsection{2D Implosion problem}

\subsection{Radiation}
\subsubsection{Marshak wave}
\subsubsection{Su-Olson problem}
\subsubsection{Radiation pressure tube}
\subsubsection{Radiation-matter energy exchange}
\subsubsection{Shadow test}
\subsubsection{Beam test}
\subsubsection{Optically-thin wind}
\subsubsection{Crooked-pipe problem}

\subsection{Radiation hydrodynamics}
\subsubsection{Subcritical radiative shock}
\subsubsection{Radiation-driven dust shell}
\subsubsection{Radiation Rayleigh-Taylor instability}

\section{Discussion}
\label{section:discussion}
\subsection{Range of applicability}
\subsection{Planned applications}

\section{Conclusions}
\label{section:conclusions}
The future is bright for radiation hydrodynamics on GPUs\dots

\section*{Acknowledgements}

This research was supported by the Australian Research Council through its Discovery Projects and Future Fellowship Funding Schemes, awards DP190101258 and FT180100375. This research was undertaken with the assistance of resources and services from the National Computational Infrastructure (NCI), which is supported by the Australian Government.

\emph{Software:} AMReX \citep{the_amrex_development_team_2021_5363443},
matplotlib \citep{Hunter:2007},
numpy \citep{harris2020array}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section*{Data Availability}
The source code and entire commit history for \textsc{Quokka} is hosted in this public \faGithub\href{https://github.com/BenWibking/quokka-code}{GitHub repository}. The version of the source code used to produce the results in this paper as well as the output files at the final timestep for the simulations shown in the Figures are permanently archived at Zenodo DOI:XXX.

%%%%%%%%%%%%%%%%%%%% REFERENCES %%%%%%%%%%%%%%%%%%

% The best way to enter references is to use BibTeX:

\bibliographystyle{mnras}
\bibliography{quokka} % if your bibtex file is called example.bib

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%% APPENDICES %%%%%%%%%%%%%%%%%%%%%

\appendix

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


% Don't change these lines
\bsp	% typesetting comment
\label{lastpage}
\end{document}

% End of mnras_template.tex
